
# Lab 06: Insert Data into MySQL Database using PHP and Arduino IDE


In this project, you’ll build an ESP32 or ESP8266 client that makes an HTTP POST request to a PHP script to insert data (sensor readings) into a MySQL database. You’ll also have a web page that displays the sensor readings, timestamps, and other information from the database. You can visualize your data from anywhere in the world by accessing your own server.

As an example, we’ll be using a BME280 sensor connected to an ESP32 or ESP8266 board. You can modify the code provided to send readings from a different sensor or use multiple boards.

In order to create and build this project, you’ll use these technologies:

-   ESP32or  ESP8266 programmed with Arduino IDE
-   Hosting server and domain name
-   PHP script to insert data into MySQL and display it on a web page
-   MySQL database to store readings

### 1. Hosting Your PHP Application and MySQL Database

The goal of this project is to have your own domain name and hosting account that allows you to store sensor readings from the ESP32 or ESP8266. You can visualize the readings from anywhere in the world by accessing your own server domain.

### 2. Preparing Your MySQL Database

After signing up for a hosting account and setting up a domain name, you can login to your cPanel or similar dashboard. After that, follow the next steps to create your database, username, password, and SQL table.

### Creating a database and user

**1.**  Type “database” in the search bar and select “MySQL Database Wizard”.

![CPanel select MySQL database wizard to create db](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/CPanel-select-MySQL-database-wizard-to-create-db.png?resize=826%2C300&quality=100&strip=all&ssl=1)

**2.**  Enter your desired Database name. In my case, the database name is  esp_data. Then, press the “Next Step” button:

![ESP32 ESP8266 CPanel Create MySQL Database](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP32-ESP8266-CPanel-Create-MySQL-Database.png?resize=609%2C443&quality=100&strip=all&ssl=1)

**Note:** later you’ll have to use the database name with the prefix that your host gives you (my database prefix in the screenshot above is blurred). I’ll refer to it as  example_esp_data  from now on.

**3.**  Type your Database username and set a password. You must save all those details, because you’ll need them later to establish a database connection with your PHP code.

![ESP32 ESP8266 CPanel Create MySQL Database User and Password](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP32-ESP8266-CPanel-Create-MySQL-Database-User-Password.png?resize=736%2C615&quality=100&strip=all&ssl=1)

That’s it! Your new database and user were created successfully. Now, save all your details because you’ll need them later:

-   **Database name**: example_esp_data
-   **Username**: example_esp_board
-   **Password**: your password

### Creating a SQL table

After creating your database and user, go back to cPanel dashboard and search for “phpMyAdmin”.

![ESP32 ESP8266 CPanel Open PHPMyAdmin](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP32-ESP8266-CPanel-Open-PHPMyAdmin.png?resize=766%2C315&quality=100&strip=all&ssl=1)

In the left sidebar, select your database name  example_esp_data  and open the “SQL” tab.

![ESP32 ESP8266 PHPMyAdmin Open Database](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP32-ESP8266-PHPMyAdmin-Open-Database.png?resize=797%2C521&quality=100&strip=all&ssl=1)

Copy the SQL query in the following snippet:

```c
CREATE TABLE SensorData (
    id INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    sensor VARCHAR(30) NOT NULL,
    location VARCHAR(30) NOT NULL,
    value1 VARCHAR(10),
    value2 VARCHAR(10),
    value3 VARCHAR(10),
    reading_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
)
```
Paste it in the SQL query field (highlighted with a red rectangle) and press the “Go” button to create your table:

![ESP32 ESP8266 PHPMyAdmin Create SQL Table](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP32-ESP8266-PHPMyAdmin-Create-SQL-Table.png?resize=828%2C412&quality=100&strip=all&ssl=1)

After that, you should see your newly created table called  SensorData  in the  example_esp_data  database as shown in the figure below:

[![ESP32 ESP8266 PHPMyAdmin View SQL Database](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP32-ESP8266-PHPMyAdmin-View-SQL-Database.png?resize=828%2C276&quality=100&strip=all&ssl=1)](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP32-ESP8266-PHPMyAdmin-View-SQL-Database.png?quality=100&strip=all&ssl=1)

## 3. PHP Script HTTP POST – Insert Data in MySQL Database

In this section, we’re going to create a PHP script that is responsible for receiving incoming requests from the ESP32 or ESP8266 and inserting the data into a MySQL database.

If you’re using a hosting provider with cPanel, you can search for “File Manager”:

![ESP32 ESP8266 CPanel Open Edit PHP Files](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP32-ESP8266-CPanel-Open-Edit-PHP-Files.png?resize=761%2C340&quality=100&strip=all&ssl=1)

Then, select the  **public_html**  option and press the “+ File” button to create a new  _.php_  file.

![ESP32 ESP8266 CPanel Create New PHP File](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP32-ESP8266-CPanel-Create-New-PHP-File.png?resize=828%2C337&quality=100&strip=all&ssl=1)

**Note:** if you’re following this tutorial and you’re not familiar with PHP or MySQL, I recommend creating these exact files. Otherwise, you’ll need to modify the ESP sketch provided with different URL paths.

Create a new file in  **/public_html**  with this exact name and extension:  _post-esp-data.php_

![PHP Create New file post esp data](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/PHP-Create-New-file-post-esp-data.png?resize=501%2C246&quality=100&strip=all&ssl=1)

Edit the newly created file (_post-esp-data.php_) and copy the following snippet:

```c
<?php
$servername = "localhost";

// REPLACE with your Database name
$dbname = "REPLACE_WITH_YOUR_DATABASE_NAME";
// REPLACE with Database user
$username = "REPLACE_WITH_YOUR_USERNAME";
// REPLACE with Database user password
$password = "REPLACE_WITH_YOUR_PASSWORD";

// Keep this API Key value to be compatible with the ESP32 code provided in the project page. 
// If you change this value, the ESP32 sketch needs to match
$api_key_value = "tPmAT5Ab3j7F9";

$api_key= $sensor = $location = $value1 = $value2 = $value3 = "";

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $api_key = test_input($_POST["api_key"]);
    if($api_key == $api_key_value) {
        $sensor = test_input($_POST["sensor"]);
        $location = test_input($_POST["location"]);
        $value1 = test_input($_POST["value1"]);
        $value2 = test_input($_POST["value2"]);
        $value3 = test_input($_POST["value3"]);
        
        // Create connection
        $conn = new mysqli($servername, $username, $password, $dbname);
        // Check connection
        if ($conn->connect_error) {
            die("Connection failed: " . $conn->connect_error);
        } 
        
        $sql = "INSERT INTO SensorData (sensor, location, value1, value2, value3)
        VALUES ('" . $sensor . "', '" . $location . "', '" . $value1 . "', '" . $value2 . "', '" . $value3 . "')";
        
        if ($conn->query($sql) === TRUE) {
            echo "New record created successfully";
        } 
        else {
            echo "Error: " . $sql . "<br>" . $conn->error;
        }
    
        $conn->close();
    }
    else {
        echo "Wrong API Key provided.";
    }

}
else {
    echo "No data posted with HTTP POST.";
}

function test_input($data) {
    $data = trim($data);
    $data = stripslashes($data);
    $data = htmlspecialchars($data);
    return $data;
}

```

[View raw code](https://github.com/RuiSantosdotme/ESP32-ESP8266-PHP-MySQL/raw/master/code/post-esp-data.php)

Before saving the file, you need to modify the  $dbname,  $username  and  $password  variables with your unique details:

```c
// Your Database name
$dbname = "example_esp_data";
// Your Database user
$username = "example_esp_board";
// Your Database user password
$password = "YOUR_USER_PASSWORD";
```

After adding the database name, username and password, save the file and continue with this tutorial. If you try to access your domain name in the next URL path, you’ll see the following:

```
https://example-domain.com/post-esp-data.php
```

![ESP32 ESP8266 Test POST ESP Data PHP URL](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/no-data-posted.png?resize=739%2C271&quality=100&strip=all&ssl=1)

## 4. PHP Script – Display Database Content

Create another PHP file in the  **/public_html**  directory that will display all the database content on a web page. Name your new file:  _esp-data.php_

![PHP Create New file esp data](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/PHP-Create-New-file-esp-data.png?resize=501%2C244&quality=100&strip=all&ssl=1)

Edit the newly created file (_esp-data.php_) and copy the following code:

```c
<!DOCTYPE html>
<html><body>
<?php

$servername = "localhost";

// REPLACE with your Database name
$dbname = "REPLACE_WITH_YOUR_DATABASE_NAME";
// REPLACE with Database user
$username = "REPLACE_WITH_YOUR_USERNAME";
// REPLACE with Database user password
$password = "REPLACE_WITH_YOUR_PASSWORD";

// Create connection
$conn = new mysqli($servername, $username, $password, $dbname);
// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
} 

$sql = "SELECT id, sensor, location, value1, value2, value3, reading_time FROM SensorData ORDER BY id DESC";

echo '<table cellspacing="5" cellpadding="5">
      <tr> 
        <td>ID</td> 
        <td>Sensor</td> 
        <td>Location</td> 
        <td>Value 1</td> 
        <td>Value 2</td>
        <td>Value 3</td> 
        <td>Timestamp</td> 
      </tr>';
 
if ($result = $conn->query($sql)) {
    while ($row = $result->fetch_assoc()) {
        $row_id = $row["id"];
        $row_sensor = $row["sensor"];
        $row_location = $row["location"];
        $row_value1 = $row["value1"];
        $row_value2 = $row["value2"]; 
        $row_value3 = $row["value3"]; 
        $row_reading_time = $row["reading_time"];
        // Uncomment to set timezone to - 1 hour (you can change 1 to any number)
        //$row_reading_time = date("Y-m-d H:i:s", strtotime("$row_reading_time - 1 hours"));
      
        // Uncomment to set timezone to + 4 hours (you can change 4 to any number)
        //$row_reading_time = date("Y-m-d H:i:s", strtotime("$row_reading_time + 4 hours"));
      
        echo '<tr> 
                <td>' . $row_id . '</td> 
                <td>' . $row_sensor . '</td> 
                <td>' . $row_location . '</td> 
                <td>' . $row_value1 . '</td> 
                <td>' . $row_value2 . '</td>
                <td>' . $row_value3 . '</td> 
                <td>' . $row_reading_time . '</td> 
              </tr>';
    }
    $result->free();
}

$conn->close();
?> 
</table>
</body>
</html>

```

[View raw code](https://github.com/RuiSantosdotme/ESP32-ESP8266-PHP-MySQL/raw/master/code/esp-data.php)

After adding the  $dbname,  $username,  and  $password  save the file and continue with this project.

```c
// Your Database name
$dbname = "example_esp_data";
// Your Database user
$username = "example_esp_board";
// Your Database user password
$password = "YOUR_USER_PASSWORD";
```

If you try to access your domain name in the following URL path, you’ll see the following:

```
https://example-domain.com/esp-data.php
```

![ESP32 ESP8266 Test ESP Data PHP URL](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP32-ESP8266-Test-ESP-Data-URL.png?resize=682%2C292&quality=100&strip=all&ssl=1)

That’s it! If you see that empty table printed in your browser, it means that everything is ready. In the next section, you’ll learn how to insert data from your ESP32 or ESP8266 into the database.

## 5. Setting up the ESP32 or ESP8266

This project is compatible with both the ESP32 and ESP8266 boards. You just need to assemble a simple circuit and upload the sketch provided to insert temperature, humidity, pressure, and more into your database every 30 seconds. The sketch is slightly different for each board.

### Parts Required

For this example, we’ll get sensor readings from the BME280 sensor. Here’s a list of parts you need to build the circuit for this project:

-   ESP32 board
-   Alternative –  ESP8266
-   BME280 sensor
-    Jumper wires
-   Breadboard
### Schematics

The BME280 sensor module we’re using communicates via I2C communication protocol, so you need to connect it to the ESP32 or ESP8266 I2C pins.

#### BME280 wiring to ESP32

The ESP32 I2C pins are:

-   **GPIO 22:** SCL (SCK)
-   **GPIO 21:** SDA (SDI)

So, assemble your circuit as shown in the next schematic diagram ([read complete Guide for ESP32 with BME280](https://randomnerdtutorials.com/esp32-bme280-arduino-ide-pressure-temperature-humidity/)).

![BME280 wiring to ESP32](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2018/03/ESP32-bme280_bb.png?resize=750%2C652&quality=100&strip=all&ssl=1)

#### BME280 wiring to ESP8266

The ESP8266 I2C pins are:

-   **GPIO 5** (D1): SCL (SCK)
-   **GPIO 4** (D2): SDA (SDI)

Assemble your circuit as in the next schematic diagram if you’re using an ESP8266 board ([read complete Guide for ESP8266 with BME280](https://randomnerdtutorials.com/esp8266-bme280-arduino-ide/)).

![BME280 wiring to ESP8266](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2019/06/ESP8266-BME280-Arduino-IDE.png?resize=705%2C532&quality=100&strip=all&ssl=1)

### ESP32 Code

Follow this section if you’re using an ESP32.  [For an ESP8266 click here](https://randomnerdtutorials.com/esp32-esp8266-mysql-database-php/#ESP8266-Code).

After installing the necessary board add-ons and libraries, copy the following code to your Arduino IDE, but don’t upload it yet. You need to make some changes to make it work for you.

```c
#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <HTTPClient.h>
#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>

// Replace with your network credentials
const char* ssid     = "REPLACE_WITH_YOUR_SSID";
const char* password = "REPLACE_WITH_YOUR_PASSWORD";

// REPLACE with your Domain name and URL path or IP address with path
const char* serverName = "https://example.com/post-esp-data.php";

// Keep this API Key value to be compatible with the PHP code provided in the project page. 
// If you change the apiKeyValue value, the PHP file /post-esp-data.php also needs to have the same key 
String apiKeyValue = "tPmAT5Ab3j7F9";

String sensorName = "BME280";
String sensorLocation = "Office";

/*#include <SPI.h>
#define BME_SCK 18
#define BME_MISO 19
#define BME_MOSI 23
#define BME_CS 5*/

#define SEALEVELPRESSURE_HPA (1013.25)

Adafruit_BME280 bme;  // I2C
//Adafruit_BME280 bme(BME_CS);  // hardware SPI
//Adafruit_BME280 bme(BME_CS, BME_MOSI, BME_MISO, BME_SCK);  // software SPI

void setup() {
  Serial.begin(115200);
  
  WiFi.begin(ssid, password);
  Serial.println("Connecting");
  while(WiFi.status() != WL_CONNECTED) { 
    delay(500);
    Serial.print(".");
  }
  Serial.println("");
  Serial.print("Connected to WiFi network with IP Address: ");
  Serial.println(WiFi.localIP());

  // (you can also pass in a Wire library object like &Wire2)
  bool status = bme.begin(0x76);
  if (!status) {
    Serial.println("Could not find a valid BME280 sensor, check wiring or change I2C address!");
    while (1);
  }
}

void loop() {
  //Check WiFi connection status
  if(WiFi.status()== WL_CONNECTED){
    WiFiClientSecure *client = new WiFiClientSecure;
    client->setInsecure(); //don't use SSL certificate
    HTTPClient https;
    
    // Your Domain name with URL path or IP address with path
    https.begin(*client, serverName);
    
    // Specify content-type header
    https.addHeader("Content-Type", "application/x-www-form-urlencoded");
    
    // Prepare your HTTP POST request data
    String httpRequestData = "api_key=" + apiKeyValue + "&sensor=" + sensorName
                          + "&location=" + sensorLocation + "&value1=" + String(bme.readTemperature())
                          + "&value2=" + String(bme.readHumidity()) + "&value3=" + String(bme.readPressure()/100.0F) + "";
    Serial.print("httpRequestData: ");
    Serial.println(httpRequestData);
    
    // You can comment the httpRequestData variable above
    // then, use the httpRequestData variable below (for testing purposes without the BME280 sensor)
    //String httpRequestData = "api_key=tPmAT5Ab3j7F9&sensor=BME280&location=Office&value1=24.75&value2=49.54&value3=1005.14";

    // Send HTTP POST request
    int httpResponseCode = https.POST(httpRequestData);
     
    // If you need an HTTP request with a content type: text/plain
    //https.addHeader("Content-Type", "text/plain");
    //int httpResponseCode = https.POST("Hello, World!");
    
    // If you need an HTTP request with a content type: application/json, use the following:
    //https.addHeader("Content-Type", "application/json");
    //int httpResponseCode = https.POST("{\"value1\":\"19\",\"value2\":\"67\",\"value3\":\"78\"}");
    
    if (httpResponseCode>0) {
      Serial.print("HTTP Response code: ");
      Serial.println(httpResponseCode);
    }
    else {
      Serial.print("Error code: ");
      Serial.println(httpResponseCode);
    }
    // Free resources
    https.end();
  }
  else {
    Serial.println("WiFi Disconnected");
  }
  //Send an HTTP POST request every 30 seconds
  delay(30000);  
}

```

[View raw code](https://github.com/RuiSantosdotme/ESP32-ESP8266-PHP-MySQL/raw/master/code/HTTPS_ESP32_MySQL_Database_PHP.ino)

#### Setting your network credentials

You need to modify the following lines with your network credentials: SSID and password. The code is well commented on where you should make the changes.

```c
// Replace with your network credentials
const char* ssid     = "REPLACE_WITH_YOUR_SSID";
const char* password = "REPLACE_WITH_YOUR_PASSWORD";
```

#### Setting your serverName

You also need to type your domain name, so the ESP publishes the readings to your own server.

```c
const char* serverName = "https://example-domain.com/post-esp-data.php";
```

Now, you can upload the code to your board.

**Note:** Most servers require you to make HTTPS requests. The code above makes HTTPS requests to be compliant with the requirements of most cloud servers nowadays.

Your server doesn’t support HTTPS? 
If you want to learn how the code works read the following section.

#### How the code works

This project is already quite long, so we won’t cover in detail how the code works, but here’s a quick summary:

-   Import all the libraries to make it work;
-   Set variables that you might want to change (apiKeyValue,  sensorName,  sensorLocation);
-   The  apiKeyValue  is just a random string that you can modify. It’s used for security reasons, so only anyone that knows your API key can publish data to your database;
-   Initialize the serial communication for debugging purposes;
-   Establish a Wi-Fi connection with your router;
-   Initialize the BME280 to get readings;
-   Initialize a secure WiFi client.

Then, in the  loop()  is where you actually make the HTTP POST request every 30 seconds with the latest BME280 readings:

```c
// Your Domain name with URL path or IP address with path
http.begin(client, serverName);

// Specify content-type header
http.addHeader("Content-Type", "application/x-www-form-urlencoded");

// Prepare your HTTP POST request data
String httpRequestData = "api_key=" + apiKeyValue + "&sensor=" + sensorName                      + "&location=" + sensorLocation + "&value1=" + String(bme.readTemperature())                      + "&value2=" + String(bme.readHumidity()) + "&value3=" + String(bme.readPressure()/100.0F) + "";

int httpResponseCode = http.POST(httpRequestData);
```

You can comment the  httpRequestData  variable above that concatenates all the BME280 readings and use the  httpRequestData  variable below for testing purposes:

```c
String httpRequestData = "api_key=tPmAT5Ab3j7F9&sensor=BME280&location=Office&value1=24.75&value2=49.54&value3=1005.14";
```
