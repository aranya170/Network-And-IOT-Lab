
# Lab 07: Publish Sensor Readings to Google Sheets

In this project, you’ll learn how to log data to Google Sheets with the ESP32 securely and reliably using a Google Service Account and Google Sheets API. We’ll use the Arduino Google Sheets Client Library. After explaining the most important basic concepts, we’ll build a Datalogger that saves temperature, humidity, pressure, and corresponding timestamp on a Google spreadsheet.

## 1. Prerequisites

Before following this tutorial, make sure you check the following prerequisites:

### Google Account

You need a Google Account to follow this project. If you don’t have a Google account, you can  [create one](https://accounts.google.com/) here.

## 2. Google Service Account

To log data securely to Google Sheets, we’ll use a Google Service Account. A service account, identified by its unique email address, is a special kind of account. It is typically used by an application or compute workload, like a Compute Engine instance, rather than being associated with a person. You can learn more about a  [service account](https://cloud.google.com/iam/docs/service-account-overview).

### Create a Google Project

You need to create a Google project and associate a Google service account to that specific project. You can do that on your main Google account or you can choose to do that on another secondary account. As always, we recommend that you use another account just for your IoT and ESP32 projects, and not your main account.

#### Create a Service Account

1. Go to  [Google Cloud Console](https://console.cloud.google.com/projectselector2/iam-admin/settings).

2. Create a new project or choose an existing project. We’ll show you how to create a new project.

![Create Google Project](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/1-Create-Project.png?resize=828%2C340&quality=100&strip=all&ssl=1)

3. Give a name to your project. Then, click Create.

![Create Google Project](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/2-Google-Cloud-Create-New-Project.png?resize=799%2C591&quality=100&strip=all&ssl=1)

Your project will be created successfully.

![Create google service account](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/3-Google-Cloud-Project-Created.png?resize=799%2C591&quality=100&strip=all&ssl=1)

4. Now, you need to create a service account for that project. At the left sidebar, click on  **Service accounts**  and then, click on  **+ Create Service Account**.

![Create google service account 1](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/4-Create-Service-Account.png?resize=828%2C449&quality=100&strip=all&ssl=1)

5. Insert a name for your Service account, then click  **Create and Continue**.

![Create google service account define set name](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/5-Service-Account-Details.png?resize=828%2C491&quality=100&strip=all&ssl=1)

6. Select the service account role. Select  **Owner**. Then, click  **Continue**.

![Create google service account 3](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/6-Service-Account-Role.png?resize=828%2C454&quality=100&strip=all&ssl=1)

7. Finally, click  **Done**.

![Create google service account 2](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/7-Service-Account-Done.png?resize=800%2C720&quality=100&strip=all&ssl=1)

You successfully create a Service Account. Now, you need to create a Key.

#### Creating a New Key

Select the project, click on the three dots icon, and then click on  **Manage Keys**.

![manage keys google cloud project](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/8-Service-Account-Actions.png?resize=828%2C436&quality=100&strip=all&ssl=1)

Then, create a new key.

![create new key google cloud project](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/9-Create-new-key.png?resize=828%2C587&quality=100&strip=all&ssl=1)

Then, select  **JSON** and click  **Create**.

![Create private key google cloud](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/10-Create-new-key-json.png?resize=554%2C349&quality=100&strip=all&ssl=1)

This will download a JSON file to your computer with the key.

Open the file, and you’ll get something similar, but with your own details:

```
{
  "type": "service_account",
  "project_id": "...",
  "private_key_id": "...",
  "private_key": "-----BEGIN PRIVATE KEY----- ...................\n-----END PRIVATE KEY-----\n",
  "client_email": ".....",
  "client_id": "....",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/...",
  "universe_domain": "googleapis.com"
}
```

Copy the  **project_id**,  **client_email**,  **private_key_id**  and  **private_key**  from the ._json_  file because you’ll need them later.

### Enable Google Sheet API

Now that you have a project, you need to enable the Google Sheet API for that project. Click on the following link:  [https://console.cloud.google.com/apis/library/sheets.googleapis.com](https://console.cloud.google.com/apis/library/sheets.googleapis.com)  and enable Google Sheets API (you need to be on the same account where you created the project).

![enable Google Sheets API](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/14-enable-google-sheets-api.png?resize=818%2C441&quality=100&strip=all&ssl=1)

### Enable Google Drive API

You also need to enable Google Drive API for your project. Open the following link  [https://console.cloud.google.com/apis/library/drive.googleapis.com](https://console.cloud.google.com/apis/library/drive.googleapis.com)  and enable the Google Drive API.

![enable Google Drive API](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/15-Enable-Google-Drive-API.png?resize=818%2C441&quality=100&strip=all&ssl=1)

## 3. Installing the Arduino Google Sheet Client Library for Arduino devices

To publish readings to Google Sheets using the Google Service Account, we’ll use  [the ESP-Google-Sheet-Client library by Mobitz](https://github.com/mobizt/ESP-Google-Sheet-Client/blob/master/examples/Values/Create_Update_Read/Create_Update_Read.ino). This library comes with methods to create, read, and delete spreadsheets and write, update, and append data to the spreadsheet file. You can find all the  [library examples](https://github.com/mobizt/ESP-Google-Sheet-Client/tree/master/examples).

In the Arduino IDE, go to  **Sketch** >  **Library** >  **Manage Libraries**. Search for  **ESP-Google-Sheet-Client**  and click  **Install**.

![install ESP Google Spreadsheet client library arduino ide](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2024/01/google-sheet-client-library-install-arduino-ide.png?resize=828%2C572&quality=100&strip=all&ssl=1)

## 4. Creating a Google Spreadsheet

Go to Google Sheets and  [create a new spreadsheet](https://docs.google.com/spreadsheets/u/0/?ec=asw-sheets-hero-goto). Give a title to your spreadsheet. For example  _ESP32 Datalogging_.

![spreadsheetid](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/spreadsheet_id.png?resize=828%2C490&quality=100&strip=all&ssl=1)

Save the spreadsheet ID. It’s highlighted in the picture above. The Spreadsheet ID is the last string of characters in the URL for your spreadsheet. For example, in the URL https://docs.google.com/spreadsheets/d/1aISQE8K79LS5c3vF18qFRcmfDRFn_9nE4nKveWBCtoQ/edit#gid=0, the spreadsheet ID is  1aISQE8K79LS5c3vF18qFRcmfDRFn_9nE4nKveWBCtoQ.

## 5. Share the Spreadsheet with the Service Account

For you to be able to log data to that spreadsheet using the Google Service Account, as we’ll do in this tutorial, you need to share the spreadsheet with the service account email. You should get the service account email in the  JSON file you downloaded previously saved on the  client_email  variable.

At the top right corner click on  **Share**. Paste the service account email and click  **Send**.

![Share spreadsheet with google service account](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/share-with-service-account-f.png?resize=828%2C490&quality=100&strip=all&ssl=1)

## 6. ESP32 with BME280 Circuit

For this particular example, we’ll log data from a BME280 sensor. So, you need to wire a BME280 sensor to your ESP32. You can also use any other sensor you’re familiar with or adjust the code to publish random values if you don’t have a sensor at hand.

### Schematic Diagram

We’re going to use I2C communication with the BME280 sensor module. For that, wire the sensor to the default ESP32 SCL (GPIO 22) and SDA (GPIO 21) pins, as shown in the following schematic diagram.

![ESP32 Wiring to BME280 Schematic Diagram](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2020/10/ESP32-BME280-Sensor-Temperature-Humidity-Pressure-Wiring-Diagram-Circuit_f.png?resize=675%2C670&quality=100&strip=all&ssl=1)

## 7. ESP32 Datalogging to Google Sheets – Arduino Sketch

Copy the following code to the Arduino IDE. Don’t upload it yet. You need to fill in some details before uploading it to the board.

```c
#include <Arduino.h>
#include <WiFi.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>
#include "time.h"
#include <ESP_Google_Sheet_Client.h>

// For SD/SD_MMC mounting helper
#include <GS_SDHelper.h>

#define WIFI_SSID "REPLACE_WITH_YOUR_SSID"
#define WIFI_PASSWORD "REPLACE_WITH_YOUR_PASSWORD"

// Google Project ID
#define PROJECT_ID "REPLACE_WITH_YOUR_PROJECT_ID"

// Service Account's client email
#define CLIENT_EMAIL "REPLACE_WITH_YOUR_CLIENT_EMAIL"

// Service Account's private key
const char PRIVATE_KEY[] PROGMEM = "-----BEGIN PRIVATE KEY-----\ REPLACE_WITH_YOUR_PRIVATE_KEY\n-----END PRIVATE KEY-----\n";

// The ID of the spreadsheet where you'll publish the data
const char spreadsheetId[] = "YOUR_SPREADSHEET_ID";

// Timer variables
unsigned long lastTime = 0;  
unsigned long timerDelay = 30000;

// Token Callback function
void tokenStatusCallback(TokenInfo info);

// BME280 I2C
Adafruit_BME280 bme;
// Variables to hold sensor readings
float temp;
float hum;
float pres;

// NTP server to request epoch time
const char* ntpServer = "pool.ntp.org";

// Variable to save current epoch time
unsigned long epochTime; 

// Function that gets current epoch time
unsigned long getTime() {
  time_t now;
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) {
    //Serial.println("Failed to obtain time");
    return(0);
  }
  time(&now);
  return now;
}

void setup(){

    Serial.begin(115200);
    Serial.println();
    Serial.println();

    //Configure time
    configTime(0, 0, ntpServer);

    // Initialize BME280 sensor 
    if (!bme.begin(0x76)) {
      Serial.println("Could not find a valid BME280 sensor, check wiring!");
      while (1);
    }

    GSheet.printf("ESP Google Sheet Client v%s\n\n", ESP_GOOGLE_SHEET_CLIENT_VERSION);

    // Connect to Wi-Fi
    WiFi.setAutoReconnect(true);
    WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  
    Serial.print("Connecting to Wi-Fi");
    while (WiFi.status() != WL_CONNECTED) {
      Serial.print(".");
      delay(1000);
    }
    Serial.println();
    Serial.print("Connected with IP: ");
    Serial.println(WiFi.localIP());
    Serial.println();

    // Set the callback for Google API access token generation status (for debug only)
    GSheet.setTokenCallback(tokenStatusCallback);

    // Set the seconds to refresh the auth token before expire (60 to 3540, default is 300 seconds)
    GSheet.setPrerefreshSeconds(10 * 60);

    // Begin the access token generation for Google API authentication
    GSheet.begin(CLIENT_EMAIL, PROJECT_ID, PRIVATE_KEY);
}

void loop(){
    // Call ready() repeatedly in loop for authentication checking and processing
    bool ready = GSheet.ready();

    if (ready && millis() - lastTime > timerDelay){
        lastTime = millis();

        FirebaseJson response;

        Serial.println("\nAppend spreadsheet values...");
        Serial.println("----------------------------");

        FirebaseJson valueRange;

        // New BME280 sensor readings
        temp = bme.readTemperature();
        //temp = 1.8*bme.readTemperature() + 32;
        hum = bme.readHumidity();
        pres = bme.readPressure()/100.0F;
        // Get timestamp
        epochTime = getTime();

        valueRange.add("majorDimension", "COLUMNS");
        valueRange.set("values/[0]/[0]", epochTime);
        valueRange.set("values/[1]/[0]", temp);
        valueRange.set("values/[2]/[0]", hum);
        valueRange.set("values/[3]/[0]", pres);

        // For Google Sheet API ref doc, go to https://developers.google.com/sheets/api/reference/rest/v4/spreadsheets.values/append
        // Append values to the spreadsheet
        bool success = GSheet.values.append(&response /* returned response */, spreadsheetId /* spreadsheet Id to append */, "Sheet1!A1" /* range to append */, &valueRange /* data range to append */);
        if (success){
            response.toString(Serial, true);
            valueRange.clear();
        }
        else{
            Serial.println(GSheet.errorReason());
        }
        Serial.println();
        Serial.println(ESP.getFreeHeap());
    }
}

void tokenStatusCallback(TokenInfo info){
    if (info.status == token_status_error){
        GSheet.printf("Token info: type = %s, status = %s\n", GSheet.getTokenType(info).c_str(), GSheet.getTokenStatus(info).c_str());
        GSheet.printf("Token error: %s\n", GSheet.getTokenError(info).c_str());
    }
    else{
        GSheet.printf("Token info: type = %s, status = %s\n", GSheet.getTokenType(info).c_str(), GSheet.getTokenStatus(info).c_str());
    }
}

```

[View raw code](https://github.com/RuiSantosdotme/Random-Nerd-Tutorials/raw/master/Projects/ESP32/ESP32_Google_Sheets.ino)

Insert your network credentials on the following variables.

```c
#define WIFI_SSID "REPLACE_WITH_YOUR_SSID"
#define WIFI_PASSWORD "REPLACE_WITH_YOUR_PASSWORD"
```

Insert your project ID, your client email, and your private key (you can find these details on the JSON file you downloaded in the previous steps).

```c
// Google Project ID
#define PROJECT_ID "REPLACE_WITH_YOUR_PROJECT_ID"

// Service Account's client email
#define CLIENT_EMAIL "REPLACE_WITH_YOUR_CLIENT_EMAIL"

// Service Account's private key
const char PRIVATE_KEY[] PROGMEM = "-----BEGIN PRIVATE KEY-----\ REPLACE_WITH_YOUR_PRIVATE_KEY\n-----END PRIVATE KEY-----\n";
```

Finally, insert the ID of the spreadsheet you want to publish your data.

```c
// The ID of the spreadsheet where you'll publish the data
const char spreadsheetId[] = "YOUR_SPREADSHEET_ID";
```

**Note: if your Google Sheets is not in English language, you might need to change  Sheet1  with the corresponding in your language**  **on the following line.**

```
bool success = GSheet.values.append(&response /* returned response */, spreadsheetId /* spreadsheet Id to append */, "Sheet1!A1" /* range to append */, &valueRange /* data range to append */);
```

You can now upload the code to your ESP32 board.

## Demonstration

After uploading the code to the ESP32, open the Serial Monitor to check the process.

The ESP32 should successfully connect to your Wi-Fi network and after 30 seconds, it should publish its first reading.

![ESP32 Publishing to Google Sheets Serial Monitor](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2024/01/ESP32-publish-to-google-sheets.png?resize=747%2C664&quality=100&strip=all&ssl=1)

Open the spreadsheet where you’re publishing the values. You should see new values being published in real-time. The first column contains the epoch time, then the temperature in Celsius degrees, the humidity, and finally the pressure in hPa.

![ESP32 Data Published to Google Spreadsheet](https://i0.wp.com/randomnerdtutorials.com/wp-content/uploads/2023/12/ESP32-datalogging-google-sheets.png?resize=828%2C577&quality=100&strip=all&ssl=1)

We’re using the timestamp in epoch time. To convert it to a readable format, you can simply use the  [EPOCHTODATE() function](https://support.google.com/docs/answer/13193461?hl=en).
